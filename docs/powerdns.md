# PowerDNS Stack Overview

The router now uses a fully containerized PowerDNS stack powered by Docker Compose and managed by the custom NixOS module `services.pdnsStack`. The stack includes:

- `dnsdist` (host network) – terminates DNS queries on the router’s HOMELAB and LAN interfaces and routes them to the appropriate backend.
- `pdns-auth-homelab` and `pdns-auth-lan` – two authoritative PowerDNS instances sharing a common MariaDB backend, allowing split-horizon records per network.
- `pdns-recursor` – resolves Internet queries and forwards local zones back to the authoritative instances.
- `powerdns-admin` and `powerdns-admin-lan` – two PowerDNS-Admin instances (one per authoritative server).
- `mariadb` + `redis` – shared database backend (multiple schemas/Redis DBs) used by the services.

All compose files and support scripts are rendered to `/etc/pdns-stack/`, while persistent data is stored under `/var/lib/powerdns-*`.

---

## Enabling the Stack

`router-config.nix` carries the input values (API keys, router IPs, upstream resolvers):

```nix
dns = {
  enable = true;
  routerIPs = [ "192.168.2.1" "192.168.3.1" ];
  upstreamResolvers = [ "9.9.9.9" "1.1.1.1" ];
  mariadbRootPassword = "replace-with-secure-root-pw";
  pdnsDbPassword = "replace-with-secure-pdns-pw";
  pdnsApiKeyHomelab = "replace-with-real-api-key-homelab";
  pdnsApiKeyLan = "replace-with-real-api-key-lan";
  powerdnsAdminSecret = "replace-with-secret";
  powerdnsAdminLanSecret = "replace-with-secret-lan";
};
```

`configuration.nix` merges those values when enabling the service:

```nix
imports = [
  # …
  ./modules/pdns-stack.nix
];

services.pdnsStack = {
  enable = true;
  routerIPs = [ "192.168.2.1" "192.168.3.1" ];
  upstreamResolvers = [ "9.9.9.9" "1.1.1.1" ];
  mariadbRootPassword = "replace-with-secure-root-pw";
  pdnsDbPassword = "replace-with-secure-pdns-pw";
  pdnsApiKeyHomelab = "replace-with-real-api-key-homelab";
  pdnsApiKeyLan = "replace-with-real-api-key-lan";
  powerdnsAdminSecret = "replace-with-secret";
  powerdnsAdminLanSecret = "replace-with-secret-lan";
};
```

Then apply the configuration and start the stack:

```bash
sudo nixos-rebuild switch
sudo systemctl start pdns-stack
sudo systemctl status pdns-stack
```

`pdns-stack` uses `docker compose up -d` behind the scenes; the service remains active (`RemainAfterExit = true`) until explicitly stopped.

---

## File Layout

| Path | Description |
| --- | --- |
| `/etc/pdns-stack/docker-compose.yml` | Docker Compose definition generated by the module |
| `/etc/pdns-stack/dnsdist/dnsdist.lua` | dnsdist configuration (binds to `services.pdnsStack.routerIPs`) |
| `/etc/pdns-stack/manage.sh` | Convenience wrapper for `docker compose` |
| `/var/lib/powerdns-mysql/` | MariaDB data files |
| `/var/lib/powerdns-admin/` | PowerDNS-Admin data & secrets (`compose.env`, Redis dumps) |

`compose.env` contains passwords and API keys rendered from the module options. Update this file carefully and restart the stack if you change any secrets.

---

## Operating the Stack

### Systemd

```bash
sudo systemctl status pdns-stack
sudo systemctl restart pdns-stack
sudo systemctl stop pdns-stack
sudo journalctl -u pdns-stack -f
```

### docker compose Wrapper

```bash
cd /etc/pdns-stack
./manage.sh ps
./manage.sh logs -f dnsdist
./manage.sh pull
./manage.sh up -d
./manage.sh down
```

### Container Logs

```bash
docker logs -f dnsdist
docker logs -f pdns-auth-homelab
docker logs -f pdns-auth-lan
docker logs -f pdns-recursor
docker logs -f powerdns-admin
docker logs -f mariadb
```

---

## DNS Endpoints and Split Horizon

- dnsdist listens on every IP in `services.pdnsStack.routerIPs` (HOMELAB + LAN).
- Requests for `jeandr.net` originating from `192.168.2.0/24` go to the HOMELAB authoritative pool.
- Requests for the same zone from `192.168.3.0/24` go to the LAN authoritative pool.
- Everything else is answered by the recursor, which forwards to the upstream resolvers list.

Verify behaviour:

```bash
dig @192.168.2.1 internal-host.jeandr.net
dig @192.168.3.1 internal-host.jeandr.net
dig @192.168.2.1 google.com
```

---

## PowerDNS-Admin UIs

| Instance | URL | Purpose | Redis DB | MariaDB schema |
| --- | --- | --- | --- | --- |
| `powerdns-admin` | `http://router-ip:8080` | HOMELAB (`pdns-auth-homelab`) | `redis://redis:6379/0` | `powerdns_admin_homelab` |
| `powerdns-admin-lan` | `http://router-ip:8081` | LAN (`pdns-auth-lan`) | `redis://redis:6379/1` | `powerdns_admin_lan` |

Both UIs start with credentials `admin` / `admin`. Change them immediately, then confirm the PDNS API settings inside each interface:

- HOMELAB: `http://172.28.0.11:8081` with `services.pdnsStack.pdnsApiKeyHomelab`
- LAN: `http://172.28.0.12:8082` with `services.pdnsStack.pdnsApiKeyLan`

---

## Backups

A simple backup routine:

```bash
ENV_FILE=/var/lib/powerdns-admin/compose.env
SQL_PASS=$(grep ^MYSQL_PASSWORD "$ENV_FILE" | cut -d= -f2)

# Dump MariaDB
docker exec -t mariadb \
  mysqldump -u pdns -p"$SQL_PASS" \
    powerdns \
    powerdns_admin_homelab \
    powerdns_admin_lan > /backup/powerdns-$(date +%Y%m%d).sql

# Tar persistent directories
sudo tar -czf /backup/powerdns-data-$(date +%Y%m%d).tar.gz \
  -C /var/lib powerdns-mysql powerdns-admin
```

Restore procedure:

```bash
sudo systemctl stop pdns-stack
sudo tar -xzf /backup/powerdns-data-YYYYMMDD.tar.gz -C /var/lib

ENV_FILE=/var/lib/powerdns-admin/compose.env
SQL_PASS=$(grep ^MYSQL_PASSWORD "$ENV_FILE" | cut -d= -f2)

mysql -h 127.0.0.1 -P 3306 -u pdns -p"$SQL_PASS" \
  powerdns < powerdns-YYYYMMDD.sql
mysql -h 127.0.0.1 -P 3306 -u pdns -p"$SQL_PASS" \
  powerdns_admin_homelab < powerdns-YYYYMMDD.sql
mysql -h 127.0.0.1 -P 3306 -u pdns -p"$SQL_PASS" \
  powerdns_admin_lan < powerdns-YYYYMMDD.sql

sudo systemctl start pdns-stack
```

---

## Security Notes

- Replace all default passwords/API keys via `services.pdnsStack` or `compose.env`.
- Restrict `routerIPs` to only the interfaces that should answer DNS (`br0`, `br1`, Tailscale, etc.).
- Consider moving secrets into SOPS or another secret manager rather than hard-coding them in Nix.
- dnsdist runs with `network_mode: host`; ensure only trusted images are used and host firewall rules allow the expected traffic (ports 53/udp+tcp, 8080, 8081).

---

## Troubleshooting Checklist

- `systemctl status pdns-stack` shows failure → inspect `journalctl -u pdns-stack`.
- Containers not running → `./manage.sh ps` or `docker ps`.
- API errors in PowerDNS-Admin → verify API key and URL (HOMELAB → `pdns-auth-homelab`, LAN → `pdns-auth-lan`).
- Split-horizon delivering wrong answers → inspect `/etc/pdns-stack/dnsdist/dnsdist.lua` and ensure subnets match actual DHCP ranges.

For deeper PowerDNS configuration guidance, consult:

- [PowerDNS Authoritative Documentation](https://doc.powerdns.com/authoritative/)
- [PowerDNS Recursor Documentation](https://doc.powerdns.com/recursor/)
- [PowerDNS-Admin GitHub](https://github.com/PowerDNS-Admin/PowerDNS-Admin)
