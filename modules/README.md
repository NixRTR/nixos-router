# NixOS Router Modules

This directory contains modular components of the NixOS router configuration. Each module handles a specific aspect of the router's functionality.

## Module Overview

### `router.nix`
**Core Networking** (Main router module)
- WAN interface configuration (DHCP or PPPoE)
- LAN bridge configuration (multiple isolated networks)
- Firewall and NAT rules
- Network isolation between bridges
- Port forwarding
- TCP/IP performance optimizations

**What it does:**
- Configures WAN connectivity (internet connection)
- Creates multiple LAN bridges with physical interface assignments
- Implements network segmentation and firewall rules
- Enables NAT for internet access
- Configures hardware offloading and TCP optimizations

### `powerdns.nix`
**DNS Services**
- PowerDNS Recursor: Recursive DNS resolver with caching
- PowerDNS Authoritative: Local zone management
- PowerDNS Admin: Web interface for DNS management (port 9191)
- Automated initialization and password synchronization

**What it does:**
- Listens on all bridge interfaces (port 53)
- Forwards queries to upstream DNS (Cloudflare, Google, Quad9)
- Provides web-based DNS management
- Syncs admin credentials with system user

### `dhcp.nix`
**DHCP Server (ISC Kea)**
- Manages dynamic IP address assignment
- Supports multiple subnets (one per bridge)
- Configurable lease times
- Per-network gateway and DNS settings

**What it does:**
- Assigns IP addresses to devices on HOMELAB and LAN networks
- Provides network configuration (gateway, DNS) via DHCP options
- Maintains lease database

### `dashboard.nix`
**Monitoring and Metrics**
- Grafana: Web-based monitoring dashboard (port 3000)
- Prometheus: Metrics collection and storage
- Node Exporter: System and network metrics
- Speedtest: Periodic internet speed tests

**What it does:**
- Provides real-time monitoring of router performance
- Collects CPU, memory, network, and disk metrics
- Runs automated speed tests every 6 hours
- Creates visualizations for network traffic and system health

### `linode-dyndns.nix`
**Dynamic DNS Updates**
- Automatic IP address detection
- Linode DNS record updates via API
- Change detection and logging
- Configurable update intervals

**What it does:**
- Monitors public IP address changes
- Updates Linode DNS records automatically
- Runs every 5 minutes to keep DNS in sync
- Logs all IP changes to system journal

### `users.nix`
**User Account Management**
- Creates system user account
- Configures sudo privileges
- Auto-login on console
- Password synchronization with sops secrets

**What it does:**
- Sets up the router administrator account
- Enables passwordless sudo for admin user
- Automatically logs in admin user on boot
- Syncs password from encrypted secrets

### `secrets.nix`
**Secrets Management (sops-nix)**
- User password (required)
- PPPoE credentials (conditional)
- Linode API token (conditional)

**What it does:**
- Manages encrypted secrets using age encryption
- Automatically generates encryption key on first boot
- Makes secrets available to system services
- Only enables secrets that are needed based on configuration

## Adding New Modules

When creating a new module:

1. Create a `.nix` file in this directory
2. Import it in `../configuration.nix`
3. Keep it focused on a single responsibility
4. Use `routerConfig` from `../router-config.nix` for user-configurable values
5. Document what it does in this README

## Module Dependencies

```
configuration.nix
├── hardware-configuration.nix (generated by nixos-generate-config)
└── modules/
    ├── secrets.nix (loaded early for sops encryption)
    ├── users.nix (depends on secrets)
    ├── router.nix (core networking, creates bridges)
    ├── powerdns.nix (depends on router bridges)
    ├── dhcp.nix (depends on router bridges)
    ├── dashboard.nix (depends on router bridges for monitoring)
    └── linode-dyndns.nix (optional, depends on secrets)
```

## Best Practices

- **Keep modules independent**: Avoid circular dependencies between modules
- **Use conditionals**: Enable features only when needed (see `secrets.nix`)
- **Document configuration**: Add comments explaining non-obvious settings
- **Test changes**: Always test in a VM before deploying to production
- **Follow NixOS conventions**: Use standard service options when available

